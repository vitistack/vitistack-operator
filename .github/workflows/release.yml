name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  packages: write
  id-token: write # Required for keyless signing with Sigstore

env:
  GO_VERSION_FILE: go.mod
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/vitistack/vitistack-operator
  HELM_REGISTRY: ghcr.io/vitistack/helm

jobs:
  # Build Go binaries for all architectures
  build-binaries:
    name: Build Binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true
          cache-dependency-path: go.sum

      - name: Build
        run: |
          GOOS=linux GOARCH=amd64 make build-static
          mv dist/vitistack-operator dist/vitistack-operator-amd64
          GOOS=linux GOARCH=arm64 make build-static
          mv dist/vitistack-operator dist/vitistack-operator-arm64

      - name: Upload binaries
        uses: actions/upload-artifact@v6
        with:
          name: binaries
          path: dist/vitistack-operator-*
          retention-days: 1

  # Build OCI images per architecture using native runners
  build-image:
    name: Build Image (${{ matrix.platform }})
    needs: build-binaries
    runs-on: ${{ matrix.platform == 'linux/arm64' && (github.event.repository.private && 'ubuntu-latest' || 'ubuntu-24.04-arm') || 'ubuntu-latest' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            arch: amd64
          - platform: linux/arm64
            arch: arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download binaries
        uses: actions/download-artifact@v7
        with:
          name: binaries
          path: dist/

      - name: Make binaries executable
        run: chmod +x dist/vitistack-operator-*

      # Uncomment for ARM support (QEMU emulation)
      # - name: Set up QEMU
      #   uses: docker/setup-qemu-action@v3
      #   with:
      #     platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=${{ matrix.platform }}
          outputs: type=image,name=${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=true

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v6
        with:
          name: digests-${{ matrix.arch }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  # Package Helm chart in parallel with image builds
  package-helm:
    name: Package Helm Chart
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Extract version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Update chart versions
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          yq -i ".version = \"${VERSION}\"" charts/vitistack-operator/Chart.yaml
          yq -i ".appVersion = \"${VERSION}\"" charts/vitistack-operator/Chart.yaml
          yq -i ".image.tag = \"${VERSION}\"" charts/vitistack-operator/values.yaml

      - name: Package Helm chart
        run: helm package charts/vitistack-operator

      - name: Generate source code SBOM
        run: make sbom-source SBOM_OUTPUT_DIR=.

      - name: Upload chart artifact
        uses: actions/upload-artifact@v6
        with:
          name: helm-chart
          path: vitistack-operator-*.tgz
          retention-days: 1

      - name: Upload source SBOM artifact
        uses: actions/upload-artifact@v6
        with:
          name: sbom-source
          path: |
            sbom-source.cdx.json
            sbom-source.spdx.json
          retention-days: 90

  # Merge multi-arch manifests and sign everything
  publish-and-sign:
    name: Publish & Sign
    needs: [build-image, package-helm]
    runs-on: ubuntu-latest
    steps:
      - name: Download digests
        uses: actions/download-artifact@v7
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: Download Helm chart
        uses: actions/download-artifact@v7
        with:
          name: helm-chart
          path: /tmp/helm

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifest
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ env.IMAGE_NAME }}@sha256:%s ' *)

      - name: Push Helm chart
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          helm push /tmp/helm/vitistack-operator-*.tgz oci://${{ env.HELM_REGISTRY }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign container image
        run: cosign sign --yes ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}

      - name: Sign Helm chart
        run: cosign sign --yes ${{ env.HELM_REGISTRY }}/vitistack-operator:${{ needs.package-helm.outputs.version }}

      - name: Checkout code for Makefile
        uses: actions/checkout@v6

      - name: Generate container SBOM
        run: make sbom-container IMG=${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }} SBOM_OUTPUT_DIR=.

      - name: Attach SBOM to container image
        run: |
          cosign attach sbom --sbom sbom-container.cdx.json ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v6
        with:
          name: sbom-container
          path: |
            sbom-container.cdx.json
            sbom-container.spdx.json
          retention-days: 90

  # Create GitHub Release with SBOMs
  create-release:
    name: Create GitHub Release
    needs: [publish-and-sign, package-helm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download source SBOM
        uses: actions/download-artifact@v7
        with:
          name: sbom-source
          path: sbom

      - name: Download container SBOM
        uses: actions/download-artifact@v7
        with:
          name: sbom-container
          path: sbom

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if release already exists
          if gh release view "${{ github.ref_name }}" --repo "${{ github.repository }}" > /dev/null 2>&1; then
            echo "Release ${{ github.ref_name }} already exists, uploading SBOM assets..."
            gh release upload "${{ github.ref_name }}" \
              --repo "${{ github.repository }}" \
              --clobber \
              sbom/sbom-source.cdx.json \
              sbom/sbom-source.spdx.json \
              sbom/sbom-container.cdx.json \
              sbom/sbom-container.spdx.json
          else
            echo "Creating new release ${{ github.ref_name }}..."
            gh release create "${{ github.ref_name }}" \
              --repo "${{ github.repository }}" \
              --generate-notes \
              --latest \
              sbom/sbom-source.cdx.json \
              sbom/sbom-source.spdx.json \
              sbom/sbom-container.cdx.json \
              sbom/sbom-container.spdx.json
          fi
